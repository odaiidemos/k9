{% extends "base.html" %}

{% block title %}التقارير المتقدمة{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row">
        <div class="col-12">
            <div class="page-header mb-4">
                <nav aria-label="breadcrumb" class="mb-2">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
                        <li class="breadcrumb-item active">التقارير</li>
                    </ol>
                </nav>
                <h1 class="h2 text-dark">
                    <i class="fas fa-chart-line me-3"></i>
                    التقارير المتقدمة
                </h1>
                <p class="lead text-muted">إنشاء ومعاينة وتصدير تقارير شاملة لجميع وحدات النظام</p>
            </div>
        </div>
    </div>

    <!-- Filters & Search Panel (Sticky) -->
    <div class="row mb-4" id="filtersSection">
        <div class="col-12">
            <div class="card shadow-sm" style="position: sticky; top: 20px; z-index: 1020;">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter me-2"></i>
                        المرشحات والبحث
                        <button class="btn btn-sm btn-outline-secondary float-end" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#filterForm">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </h5>
                </div>
                <div class="collapse show" id="filterForm">
                    <div class="card-body">
                        <form id="advancedFilterForm">
                            <div class="row g-3">
                                <!-- Date Range with Quick Shortcuts -->
                                <div class="col-md-4">
                                    <label class="form-label">فترة التاريخ</label>
                                    <div class="mb-2">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('today')">اليوم</button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('week')">الأسبوع</button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('month')">الشهر</button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('year')">السنة</button>
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <input type="date" class="form-control" id="filterStartDate" name="start_date">
                                        <span class="input-group-text">إلى</span>
                                        <input type="date" class="form-control" id="filterEndDate" name="end_date">
                                    </div>
                                </div>
                                
                                <!-- Report Type -->
                                <div class="col-md-4">
                                    <label class="form-label">نوع التقرير</label>
                                    <select class="form-select" id="filterReportType" name="report_type" onchange="updateEntityFilters()">
                                        <option value="">اختر نوع التقرير</option>
                                        <option value="dogs" {% if pre_selected_type == 'dogs' %}selected{% endif %}>تقرير الكلاب</option>
                                        <option value="employees" {% if pre_selected_type == 'employees' %}selected{% endif %}>تقرير الموظفين</option>
                                        <option value="training" {% if pre_selected_type == 'training' %}selected{% endif %}>تقرير التدريب</option>
                                        <option value="veterinary" {% if pre_selected_type == 'veterinary' %}selected{% endif %}>تقرير الطبابة</option>
                                        <option value="breeding" {% if pre_selected_type == 'breeding' %}selected{% endif %}>تقرير التربية</option>
                                        <optgroup label="نظام الإنتاج">
                                            <option value="production_maturity">البلوغ</option>
                                            <option value="production_heat_cycles">الدورة</option>
                                            <option value="production_mating">التزاوج</option>
                                            <option value="production_pregnancy">الحمل</option>
                                            <option value="production_delivery">الولادة</option>
                                            <option value="production_puppies">الجراء</option>
                                            <option value="production_puppy_training">تدريب الجراء</option>
                                        </optgroup>
                                        <option value="projects" {% if pre_selected_type == 'projects' %}selected{% endif %}>تقرير المشاريع</option>
                                        <optgroup label="تقارير يومية">
                                            <option value="attendance_daily">تقرير الحضور اليومي</option>
                                            <option value="attendance_pm_daily">تقرير المسؤول اليومي</option>
                                            <option value="training_trainer_daily">تقرير المدرب اليومي</option>
                                        </optgroup>
                                    </select>
                                </div>
                                
                                <!-- Full-Text Keyword Search -->
                                <div class="col-md-4">
                                    <label class="form-label">البحث الشامل</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="filterKeyword" 
                                               placeholder="ابحث في النصوص والملاحظات...">
                                        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Entity-Specific Filters (Dynamic) -->
                            <div class="row g-3 mt-2" id="entitySpecificFilters" style="display: none;">
                                <!-- Dogs Filters -->
                                <div class="dogs-filters" style="display: none;">
                                    <div class="col-md-3">
                                        <label class="form-label">السلالة</label>
                                        <input type="text" class="form-control" name="breed" placeholder="أدخل السلالة">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">العمر (سنوات)</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="number" class="form-control" name="age_min" placeholder="من" min="0" max="20">
                                            </div>
                                            <div class="col-6">
                                                <input type="number" class="form-control" name="age_max" placeholder="إلى" min="0" max="20">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">الجنس</label>
                                        <select class="form-select" name="gender" multiple>
                                            <option value="MALE">ذكر</option>
                                            <option value="FEMALE">أنثى</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">حالة التدريب</label>
                                        <select class="form-select" name="training_status" multiple>
                                            <option value="ACTIVE">نشط</option>
                                            <option value="TRAINING">تحت التدريب</option>
                                            <option value="RETIRED">متقاعد</option>
                                            <option value="DECEASED">متوفى</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Employees Filters -->
                                <div class="employees-filters" style="display: none;">
                                    <div class="col-md-3">
                                        <label class="form-label">الوظيفة</label>
                                        <select class="form-select" name="role" multiple>
                                            <option value="HANDLER">معالج</option>
                                            <option value="TRAINER">مدرب</option>
                                            <option value="VET">طبيب بيطري</option>
                                            <option value="PROJECT_MANAGER">مدير مشروع</option>
                                            <option value="BREEDER">مربي</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">تاريخ التعيين</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="date" class="form-control" name="hire_date_min" placeholder="من">
                                            </div>
                                            <div class="col-6">
                                                <input type="date" class="form-control" name="hire_date_max" placeholder="إلى">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">الفترة</label>
                                        <select class="form-select" name="shift" multiple>
                                            <option value="MORNING">صباحي</option>
                                            <option value="EVENING">مسائي</option>
                                            <option value="NIGHT">ليلي</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">الحالة الوظيفية</label>
                                        <select class="form-select" name="employment_status" multiple>
                                            <option value="ACTIVE">نشط</option>
                                            <option value="INACTIVE">غير نشط</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Projects Filters -->
                                <div class="projects-filters" style="display: none;">
                                    <div class="col-md-3">
                                        <label class="form-label">حالة المشروع</label>
                                        <select class="form-select" name="project_status" multiple>
                                            <option value="PLANNED">مخطط</option>
                                            <option value="ACTIVE">نشط</option>
                                            <option value="COMPLETED">مكتمل</option>
                                            <option value="CANCELLED">ملغى</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">مستوى الأولوية</label>
                                        <select class="form-select" name="priority_level" multiple>
                                            <option value="LOW">منخفض</option>
                                            <option value="MEDIUM">متوسط</option>
                                            <option value="HIGH">عالي</option>
                                            <option value="CRITICAL">حرج</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">نوع المشروع</label>
                                        <select class="form-select" name="project_type" multiple>
                                            <option value="TRAINING">تدريب</option>
                                            <option value="SECURITY">أمني</option>
                                            <option value="PATROL">دورية</option>
                                            <option value="SEARCH">بحث</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">المجموعة الجغرافية</label>
                                        <input type="text" class="form-control" name="location_cluster" placeholder="المنطقة أو المجموعة">
                                    </div>
                                </div>
                                
                                <!-- Training Filters -->
                                <div class="training-filters" style="display: none;">
                                    <div class="col-md-3">
                                        <label class="form-label">فئة التدريب</label>
                                        <select class="form-select" name="training_category" multiple>
                                            <option value="OBEDIENCE">طاعة</option>
                                            <option value="DETECTION">كشف</option>
                                            <option value="AGILITY">رشاقة</option>
                                            <option value="ATTACK">هجوم</option>
                                            <option value="FITNESS">لياقة</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">تقييم النجاح</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="number" class="form-control" name="rating_min" placeholder="من" min="0" max="10">
                                            </div>
                                            <div class="col-6">
                                                <input type="number" class="form-control" name="rating_max" placeholder="إلى" min="0" max="10">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">مدة الجلسة (دقيقة)</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="number" class="form-control" name="duration_min" placeholder="من" min="0">
                                            </div>
                                            <div class="col-6">
                                                <input type="number" class="form-control" name="duration_max" placeholder="إلى" min="0">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">المدرب</label>
                                        <select class="form-select" name="trainer_id">
                                            <option value="">جميع المدربين</option>
                                            {% for employee in employees %}
                                                {% if employee.role.value == 'TRAINER' %}
                                                <option value="{{ employee.id }}">{{ employee.name or 'مدرب' }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Veterinary Filters -->
                                <div class="veterinary-filters" style="display: none;">
                                    <div class="col-md-3">
                                        <label class="form-label">نوع الزيارة</label>
                                        <select class="form-select" name="visit_type" multiple>
                                            <option value="ROUTINE">روتينية</option>
                                            <option value="EMERGENCY">طارئة</option>
                                            <option value="VACCINATION">تطعيم</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">الطبيب البيطري</label>
                                        <select class="form-select" name="vet_id">
                                            <option value="">جميع الأطباء</option>
                                            {% for employee in employees %}
                                                {% if employee.role == 'VET' or (employee.role and employee.role.value == 'VET') %}
                                                <option value="{{ employee.id }}">{{ employee.name or 'طبيب بيطري' }} - {{ employee.role }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">كلمات مفتاحية في التشخيص</label>
                                        <input type="text" class="form-control" name="diagnosis_keyword" placeholder="ابحث في التشخيص">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">نوع العلاج</label>
                                        <input type="text" class="form-control" name="treatment_type" placeholder="نوع العلاج">
                                    </div>
                                </div>
                                
                                <!-- Breeding Filters -->
                                <div class="breeding-filters" style="display: none;">
                                    <div class="col-md-3">
                                        <label class="form-label">نوع السجل</label>
                                        <select class="form-select" name="breeding_type" multiple>
                                            <option value="feeding">التغذية</option>
                                            <option value="checkup">الفحص اليومي</option>
                                            <option value="grooming">التنظيف والعناية</option>
                                            <option value="deworming">مكافحة الديدان</option>
                                            <option value="excretion">الإخراج</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">طريقة الإطعام</label>
                                        <select class="form-select" name="feeding_method" multiple>
                                            <option value="BOWL">وعاء</option>
                                            <option value="HAND">يدوي</option>
                                            <option value="AUTOMATIC">تلقائي</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">حالة الجسم</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="number" class="form-control" name="body_condition_min" placeholder="من" min="1" max="9">
                                            </div>
                                            <div class="col-6">
                                                <input type="number" class="form-control" name="body_condition_max" placeholder="إلى" min="1" max="9">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">ملاحظات خاصة</label>
                                        <input type="text" class="form-control" name="breeding_notes" placeholder="ابحث في الملاحظات">
                                    </div>
                                </div>

                                <!-- Production Filters -->
                                <div class="production-filters" style="display: none;">
                                    <div class="col-md-3">
                                        <label class="form-label">نوع الدورة</label>
                                        <select class="form-select" name="cycle_type" multiple>
                                            <option value="NATURAL">طبيعي</option>
                                            <option value="ARTIFICIAL">صناعي</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">شهر الولادة المتوقع</label>
                                        <select class="form-select" name="expected_delivery_month">
                                            <option value="">جميع الأشهر</option>
                                            <option value="1">يناير</option>
                                            <option value="2">فبراير</option>
                                            <option value="3">مارس</option>
                                            <option value="4">أبريل</option>
                                            <option value="5">مايو</option>
                                            <option value="6">يونيو</option>
                                            <option value="7">يوليو</option>
                                            <option value="8">أغسطس</option>
                                            <option value="9">سبتمبر</option>
                                            <option value="10">أكتوبر</option>
                                            <option value="11">نوفمبر</option>
                                            <option value="12">ديسمبر</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">نتيجة الدورة</label>
                                        <select class="form-select" name="cycle_outcome" multiple>
                                            <option value="SUCCESSFUL">ناجحة</option>
                                            <option value="FAILED">فاشلة</option>
                                            <option value="UNKNOWN">قيد المتابعة</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">عدد الجراء</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="number" class="form-control" name="puppies_min" placeholder="من" min="0">
                                            </div>
                                            <div class="col-6">
                                                <input type="number" class="form-control" name="puppies_max" placeholder="إلى" min="0">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Advanced Filters Toggle -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="button" class="btn btn-outline-info btn-sm" 
                                            data-bs-toggle="collapse" data-bs-target="#advancedFilters">
                                        <i class="fas fa-cog me-1"></i>
                                        فلاتر متقدمة
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Advanced Filters Panel -->
                            <div class="collapse mt-3" id="advancedFilters">
                                <div class="border-top pt-3">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label">الموقع</label>
                                            <input type="text" class="form-control" id="filterLocation" name="location" placeholder="أدخل الموقع">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">مدير المشروع</label>
                                            <select class="form-select" id="filterManager" name="manager" multiple>
                                                {% for employee in employees %}
                                                    {% if employee.role.value == 'PROJECT_MANAGER' %}
                                                    <option value="{{ employee.id }}">{{ employee.name }}</option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">وجود مرفقات</label>
                                            <select class="form-select" name="has_attachments">
                                                <option value="">الكل</option>
                                                <option value="true">مع مرفقات</option>
                                                <option value="false">بدون مرفقات</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">العلامات المخصصة</label>
                                            <input type="text" class="form-control" name="custom_tags" placeholder="عاجل، متابعة، أولوية">
                                        </div>
                                    </div>
                                    
                                    <!-- Conditional Logic Panel -->
                                    <div class="row g-3 mt-2">
                                        <div class="col-12">
                                            <div class="card border-info">
                                                <div class="card-header bg-light">
                                                    <h6 class="card-title mb-0">
                                                        <i class="fas fa-project-diagram me-2"></i>
                                                        المنطق الشرطي للمرشحات
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row g-3">
                                                        <div class="col-md-6">
                                                            <label class="form-label">منطق الدمج</label>
                                                            <div class="form-check form-check-inline">
                                                                <input class="form-check-input" type="radio" name="filter_logic" value="AND" checked>
                                                                <label class="form-check-label">AND (و)</label>
                                                            </div>
                                                            <div class="form-check form-check-inline">
                                                                <input class="form-check-input" type="radio" name="filter_logic" value="OR">
                                                                <label class="form-check-label">OR (أو)</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label class="form-label">فترات نشاط خاصة</label>
                                                            <select class="form-select" name="activity_filter">
                                                                <option value="">الكل</option>
                                                                <option value="no_activity_30">بدون نشاط خلال 30 يوم</option>
                                                                <option value="frequent_incidents">حوادث متكررة</option>
                                                                <option value="overdue_training">تدريب متأخر</option>
                                                                <option value="no_vet_visit_90">بدون زيارة بيطرية 90 يوم</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <button type="button" class="btn btn-primary me-2" onclick="applyFilters()">
                                        <i class="fas fa-search me-1"></i>
                                        تطبيق المرشحات
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                                        <i class="fas fa-undo me-1"></i>
                                        إعادة تعيين
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Badges -->
    <div class="row mb-3" id="summarySection" style="display: none;">
        <div class="col-12">
            <div class="d-flex flex-wrap gap-3">
                <span class="badge bg-primary fs-6" id="totalRecords">إجمالي السجلات: 0</span>
                <span class="badge bg-info fs-6" id="filteredRecords">السجلات المفلترة: 0</span>
                <span class="badge bg-success fs-6" id="dateRange">الفترة الزمنية: غير محدد</span>
            </div>
        </div>
    </div>

    <!-- Live Preview Panel -->
    <div class="row" id="previewSection" style="display: none;">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table me-2"></i>
                        معاينة البيانات
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" onclick="previewReport()">
                            <i class="fas fa-eye me-1"></i>
                            معاينة PDF
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportReport('pdf')">
                            <i class="fas fa-file-pdf me-1"></i>
                            تصدير PDF
                        </button>
                        <button class="btn btn-info btn-sm" onclick="exportReport('excel')">
                            <i class="fas fa-file-excel me-1"></i>
                            تصدير Excel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Data table will be populated dynamically -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="dataTable">
                            <thead class="table-dark">
                                <!-- Headers will be populated dynamically -->
                            </thead>
                            <tbody>
                                <!-- Data rows will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <label class="form-label me-2 mb-0">عدد الصفوف:</label>
                                <select class="form-select w-auto" id="rowsPerPage" onchange="updateTable()">
                                    <option value="10">10</option>
                                    <option value="25" selected>25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <nav aria-label="Table pagination">
                                <ul class="pagination justify-content-end mb-0" id="pagination">
                                    <!-- Pagination will be populated dynamically -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Preview Modal -->
<div class="modal fade" id="reportPreviewModal" tabindex="-1" aria-labelledby="reportPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportPreviewModalLabel">معاينة التقرير</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="preview-container" style="background: white; border: 1px solid #ddd; min-height: 600px; direction: rtl;">
                    <!-- PDF-like preview will be populated here -->
                    <div id="previewContent" class="p-4">
                        <div class="text-center mb-4">
                            <h3 style="color: #C00000;">معاينة التقرير</h3>
                        </div>
                        <div id="previewData">
                            <!-- Preview content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-left me-1"></i>
                    العودة للجدول
                </button>
                <button type="button" class="btn btn-primary" onclick="exportFromPreview()">
                    <i class="fas fa-download me-1"></i>
                    تحميل الآن
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.report-card {
    transition: transform 0.2s ease-in-out;
}

.report-card:hover {
    transform: translateY(-5px);
}

.table th {
    position: sticky;
    top: 0;
    background: #343a40 !important;
    color: white !important;
    z-index: 10;
}

.preview-container {
    font-family: 'Cairo', 'Amiri', sans-serif;
}

@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .btn-group .btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
}
</style>

<script>
let currentData = [];
let currentPage = 1;
let rowsPerPage = 25;
let totalRecords = 0;

// Quick date range functions
function setDateRange(period) {
    const today = new Date();
    const startDate = new Date();
    
    switch(period) {
        case 'today':
            break;
        case 'week':
            startDate.setDate(today.getDate() - 7);
            break;
        case 'month':
            startDate.setMonth(today.getMonth() - 1);
            break;
        case 'year':
            startDate.setFullYear(today.getFullYear() - 1);
            break;
    }
    
    document.getElementById('filterStartDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('filterEndDate').value = today.toISOString().split('T')[0];
}

// Update entity-specific filters based on selected report type
function updateEntityFilters() {
    const reportType = document.getElementById('filterReportType').value;
    const entityFilters = document.getElementById('entitySpecificFilters');
    const allFilterSections = entityFilters.querySelectorAll('[class$="-filters"]');
    
    // Special handling for production options - redirect to specific production management pages
    if (reportType.startsWith('production_')) {
        const productionType = reportType.replace('production_', '');
        let redirectUrl = '';
        
        switch(productionType) {
            case 'maturity':
                redirectUrl = "{{ url_for('main.production_list') }}#maturity";
                break;
            case 'heat_cycles':
                redirectUrl = "/production/heat-cycles";
                break;
            case 'mating':
                redirectUrl = "/production/mating";
                break;
            case 'pregnancy':
                redirectUrl = "/production/pregnancy";
                break;
            case 'delivery':
                redirectUrl = "/production/delivery";
                break;
            case 'puppies':
                redirectUrl = "/production/puppies";
                break;
            case 'puppy_training':
                redirectUrl = "/production/puppy-training";
                break;
            default:
                redirectUrl = "{{ url_for('main.production_list') }}";
        }
        
        window.location.href = redirectUrl;
        return;
    }
    
    // Hide all filter sections
    allFilterSections.forEach(section => section.style.display = 'none');
    
    if (reportType) {
        entityFilters.style.display = 'block';
        const targetSection = entityFilters.querySelector(`.${reportType}-filters`);
        if (targetSection) {
            targetSection.style.display = 'block';
        }
    } else {
        entityFilters.style.display = 'none';
    }
}

// Clear search function
function clearSearch() {
    document.getElementById('filterKeyword').value = '';
}

// Enhanced form data collection including all advanced filters
function collectFormData() {
    const formData = new FormData(document.getElementById('advancedFilterForm'));
    
    // Handle multi-select fields
    const multiSelectFields = ['gender', 'training_status', 'role', 'shift', 'employment_status', 
                               'project_status', 'priority_level', 'project_type', 'training_category',
                               'visit_type', 'cycle_type', 'cycle_outcome', 'manager'];
    
    multiSelectFields.forEach(field => {
        const select = document.querySelector(`select[name="${field}"]`);
        if (select && select.multiple) {
            const selectedValues = Array.from(select.selectedOptions).map(option => option.value);
            if (selectedValues.length > 0) {
                formData.delete(field);
                selectedValues.forEach(value => formData.append(`${field}[]`, value));
            }
        }
    });
    
    return formData;
}

function applyFilters() {
    const formData = collectFormData();
    const reportType = formData.get('report_type');
    
    if (!reportType) {
        alert('يرجى اختيار نوع التقرير');
        return;
    }
    
    // Show loading state
    document.getElementById('summarySection').style.display = 'block';
    document.getElementById('previewSection').style.display = 'block';
    document.getElementById('dataTable').innerHTML = '<tbody><tr><td colspan="100%" class="text-center"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</td></tr></tbody>';
    
    // Make AJAX request to get filtered data
    fetch('/reports/preview', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        currentData = data.records || [];
        totalRecords = data.total || 0;
        updateSummary(data);
        updateTable();
    })
    .catch(error => {
        if (error && error.message) { console.error('Error:', error.message); }
        document.getElementById('dataTable').innerHTML = `<tbody><tr><td colspan="100%" class="text-center text-danger"><i class="fas fa-exclamation-triangle"></i> حدث خطأ: ${error.message}</td></tr></tbody>`;
    });
}

function updateSummary(data) {
    document.getElementById('totalRecords').textContent = `إجمالي السجلات: ${data.total}`;
    document.getElementById('filteredRecords').textContent = `السجلات المفلترة: ${data.filtered}`;
    
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;
    const dateRangeText = (startDate && endDate) ? `${startDate} إلى ${endDate}` : 'غير محدد';
    document.getElementById('dateRange').textContent = `الفترة الزمنية: ${dateRangeText}`;
}

function updateTable() {
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageData = currentData.slice(start, end);
    
    if (pageData.length === 0) {
        document.getElementById('dataTable').innerHTML = '<tbody><tr><td colspan="100%" class="text-center">لا توجد بيانات</td></tr></tbody>';
        return;
    }
    
    // Build table headers and rows
    const headers = Object.keys(pageData[0]);
    let tableHTML = '<thead class="table-dark"><tr>';
    headers.forEach(header => {
        tableHTML += `<th class="sortable" onclick="sortTable('${header}')">${header} <i class="fas fa-sort"></i></th>`;
    });
    tableHTML += '</tr></thead><tbody>';
    
    pageData.forEach((row, index) => {
        tableHTML += '<tr>';
        headers.forEach(header => {
            tableHTML += `<td>${row[header] || ''}</td>`;
        });
        tableHTML += '</tr>';
    });
    tableHTML += '</tbody>';
    
    document.getElementById('dataTable').innerHTML = tableHTML;
    updatePagination();
}

function updatePagination() {
    const totalPages = Math.ceil(currentData.length / rowsPerPage);
    let paginationHTML = '';
    
    if (totalPages > 1) {
        // Previous button
        paginationHTML += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">السابق</a>
        </li>`;
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage || i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>`;
            } else if (i === currentPage - 2 || i === currentPage + 2) {
                paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }
        
        // Next button
        paginationHTML += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">التالي</a>
        </li>`;
    }
    
    document.getElementById('pagination').innerHTML = paginationHTML;
}

function changePage(page) {
    const totalPages = Math.ceil(currentData.length / rowsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateTable();
    }
}

function sortTable(column) {
    currentData.sort((a, b) => {
        if (a[column] < b[column]) return -1;
        if (a[column] > b[column]) return 1;
        return 0;
    });
    updateTable();
}

function resetFilters() {
    document.getElementById('advancedFilterForm').reset();
    document.getElementById('summarySection').style.display = 'none';
    document.getElementById('previewSection').style.display = 'none';
    currentData = [];
    currentPage = 1;
}

function previewReport() {
    const formData = collectFormData();
    
    // Show preview modal with loading
    const modal = new bootstrap.Modal(document.getElementById('reportPreviewModal'));
    document.getElementById('previewData').innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><br>جاري تحميل المعاينة...</div>';
    modal.show();
    
    // Load preview content
    fetch('/reports/preview-pdf', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.text();
    })
    .then(html => {
        document.getElementById('previewData').innerHTML = html;
    })
    .catch(error => {
        if (error && error.message) { console.error('Error:', error.message); }
        document.getElementById('previewData').innerHTML = `<div class="alert alert-danger">حدث خطأ في تحميل المعاينة: ${error.message}</div>`;
    });
}

function exportReport(format) {
    const formData = collectFormData();
    formData.append('export_format', format);
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/reports/generate';
    
    for (let [key, value] of formData.entries()) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
    }
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}

function exportFromPreview() {
    exportReport('pdf');
    bootstrap.Modal.getInstance(document.getElementById('reportPreviewModal')).hide();
}

// Auto-update rows per page
document.getElementById('rowsPerPage').addEventListener('change', function() {
    rowsPerPage = parseInt(this.value);
    currentPage = 1;
    updateTable();
});

// Initialize the reports page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Reports page initialized');
    
    // Initialize multi-select dropdowns with Bootstrap styling
    const multiSelects = document.querySelectorAll('select[multiple]');
    multiSelects.forEach(select => {
        select.classList.add('form-select');
        select.style.height = 'auto';
        select.size = Math.min(select.options.length, 3);
    });
    
    // Check if a report type was pre-selected from navigation
    const preSelectedType = '{{ pre_selected_type }}';
    if (preSelectedType && preSelectedType !== 'None') {
        // Trigger updateEntityFilters to show appropriate filters
        updateEntityFilters();
        // Auto-apply filters after a short delay
        setTimeout(applyFilters, 300);
    }
    
    // Auto-apply filters when report type changes
    document.getElementById('filterReportType').addEventListener('change', function() {
        if (this.value) {
            setTimeout(applyFilters, 100); // Small delay to allow UI update
        }
    });
    
    // Real-time search on keyword input (with debouncing)
    let searchTimeout;
    document.getElementById('filterKeyword').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (document.getElementById('filterReportType').value) {
                applyFilters();
            }
        }, 500); // 500ms delay
    });
});
</script>
{% endblock %}