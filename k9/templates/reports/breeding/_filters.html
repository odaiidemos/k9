<!-- Reusable filter bar for feeding reports -->
<div class="card mb-4" id="feeding-filters">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-filter me-2"></i>
            المرشحات
        </h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <!-- Project Selection -->
            <div class="col-md-4">
                <label for="project-select" class="form-label">المشروع</label>
                <select class="form-select" id="project-select" name="project_id">
                    <option value="">اختر المشروع...</option>
                    {% for project in accessible_projects %}
                    <option value="{{ project.id }}" 
                            {% if project.id == selected_project_id %}selected{% endif %}>
                        {{ project.name }} ({{ project.code }})
                    </option>
                    {% endfor %}
                </select>
                <div class="invalid-feedback">
                    خطأ في اختيار المشروع
                </div>
            </div>
            
            <!-- Date or Week Selection - Dynamic based on report type -->
            {% if report_type == 'daily' %}
            <div class="col-md-4">
                <label for="date-select" class="form-label">التاريخ</label>
                <input type="date" 
                       class="form-control" 
                       id="date-select" 
                       name="date" 
                       value="{{ selected_date }}"
                       required>
                <div class="invalid-feedback">
                    يرجى اختيار تاريخ صحيح
                </div>
            </div>
            {% else %}
            <div class="col-md-4">
                <label for="week-start-select" class="form-label">بداية الأسبوع</label>
                <input type="date" 
                       class="form-control" 
                       id="week-start-select" 
                       name="week_start" 
                       value="{{ selected_week_start }}"
                       required>
                <div class="invalid-feedback">
                    يرجى اختيار تاريخ بداية الأسبوع
                </div>
            </div>
            {% endif %}
            
            <!-- Optional Dog Filter -->
            <div class="col-md-4">
                <label for="dog-select" class="form-label">الكلب (اختياري)</label>
                <select class="form-select" id="dog-select" name="dog_id">
                    <option value="">جميع الكلاب</option>
                    <!-- Dogs will be populated dynamically based on selected project -->
                </select>
                <div class="invalid-feedback">
                    خطأ في اختيار الكلب
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="d-flex gap-2 justify-content-end">
                    <button type="button" 
                            class="btn btn-primary" 
                            id="load-report-btn"
                            disabled>
                        <i class="fas fa-chart-bar me-2"></i>
                        عرض التقرير
                    </button>
                    
                    <button type="button" 
                            class="btn btn-success" 
                            id="export-pdf-btn"
                            disabled>
                        <i class="fas fa-file-pdf me-2"></i>
                        تصدير PDF
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div class="row mt-2">
            <div class="col-12">
                <div class="text-center d-none" id="loading-indicator">
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                        <span class="visually-hidden">جاري التحميل...</span>
                    </div>
                    <span class="text-muted">جاري معالجة الطلب...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Enable/disable buttons based on form validity
document.addEventListener('DOMContentLoaded', function() {
    const projectSelect = document.getElementById('project-select');
    const dateSelect = document.getElementById('date-select');
    const weekStartSelect = document.getElementById('week-start-select');
    const dogSelect = document.getElementById('dog-select');
    const loadBtn = document.getElementById('load-report-btn');
    const exportBtn = document.getElementById('export-pdf-btn');
    
    function updateButtonStates() {
        const hasProject = projectSelect.value.trim() !== '';
        let hasDateOrWeek = false;
        
        if (dateSelect) {
            hasDateOrWeek = dateSelect.value.trim() !== '';
        } else if (weekStartSelect) {
            hasDateOrWeek = weekStartSelect.value.trim() !== '';
        }
        
        const isValid = hasDateOrWeek; // Only require date/week, project is optional
        
        loadBtn.disabled = !isValid;
        exportBtn.disabled = !isValid;
    }
    
    // Update button states on change
    projectSelect.addEventListener('change', function() {
        updateButtonStates();
        // Load dogs for selected project (or all dogs if no project)
        loadDogsForProject(this.value);
    });
    
    if (dateSelect) {
        dateSelect.addEventListener('change', updateButtonStates);
    }
    if (weekStartSelect) {
        weekStartSelect.addEventListener('change', updateButtonStates);
    }
    
    // Initial check
    updateButtonStates();
    
    // Load dogs initially (all dogs if no project selected)
    loadDogsForProject(projectSelect.value || '');
});

// Function to load dogs for selected project (or all dogs)
function loadDogsForProject(projectId) {
    const dogSelect = document.getElementById('dog-select');
    
    // Clear existing options
    dogSelect.innerHTML = '<option value="">جاري التحميل...</option>';
    
    // Build API URL - if no project selected, get all dogs
    let apiUrl = '/api/dogs?status=ACTIVE&limit=100';
    if (projectId) {
        apiUrl += `&project_id=${projectId}`;
    }
    
    // Load dogs using the main dogs API
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            dogSelect.innerHTML = '<option value="">جميع الكلاب</option>';
            if (data.success && data.data) {
                data.data.forEach(dog => {
                    const option = document.createElement('option');
                    option.value = dog.id;
                    option.textContent = `${dog.name} (${dog.code || dog.id.substring(0,8)})`;
                    dogSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading dogs:', error);
            dogSelect.innerHTML = '<option value="">جميع الكلاب</option>';
        });
}
</script>