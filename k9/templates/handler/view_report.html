{% extends "base.html" %}

{% block title %}عرض التقرير - {{ report.date.strftime('%Y-%m-%d') }}{% endblock %}

{% block extra_css %}
<style>
.section-card {
    border-right: 4px solid #0d6efd;
    margin-bottom: 1.5rem;
}
.form-section-header {
    background-color: #f8f9fa;
    border-bottom: 2px solid #0d6efd;
    padding: 1rem;
    font-weight: bold;
}
.info-row {
    border-bottom: 1px solid #eee;
    padding: 0.75rem 0;
}
.info-row:last-child {
    border-bottom: none;
}
.health-check-row {
    border-bottom: 1px solid #dee2e6;
    padding: 1rem 0;
}
.health-check-row:last-child {
    border-bottom: none;
}
.training-table {
    width: 100%;
}
.training-table th {
    background-color: #f8f9fa;
    font-weight: bold;
    padding: 0.75rem;
    border: 1px solid #dee2e6;
}
.training-table td {
    padding: 0.75rem;
    border: 1px solid #dee2e6;
}
.status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-weight: 600;
}
.status-normal {
    background-color: #d1f5d3;
    color: #0f5132;
}
.status-abnormal {
    background-color: #f8d7da;
    color: #842029;
}
.status-needs {
    background-color: #fff3cd;
    color: #856404;
}
.print-hide {
    display: block;
}
@media print {
    .print-hide {
        display: none !important;
    }
    .navbar, nav {
        display: none !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row print-hide">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-file-alt me-2"></i>
                عرض التقرير اليومي
            </h1>
            <div class="btn-group">
                {% if report.status.value == 'DRAFT' %}
                <a href="{{ url_for('handler.edit_report', id=report.id) }}" class="btn btn-warning">
                    <i class="fas fa-edit me-2"></i>
                    تعديل
                </a>
                {% endif %}
                <button onclick="window.print()" class="btn btn-outline-primary">
                    <i class="fas fa-print me-2"></i>
                    طباعة
                </button>
                <a href="{{ url_for('handler.my_reports') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-right me-2"></i>
                    العودة
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Report Status Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-row">
                            <strong>التاريخ:</strong>
                            <span class="ms-2">{{ report.date.strftime('%Y-%m-%d') }}</span>
                        </div>
                        <div class="info-row">
                            <strong>السائس:</strong>
                            <span class="ms-2">{{ report.handler.full_name if report.handler else current_user.full_name }}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-row">
                            <strong>حالة التقرير:</strong>
                            {% if report.status.value == 'DRAFT' %}
                                <span class="badge bg-secondary ms-2">مسودة</span>
                            {% elif report.status.value == 'SUBMITTED' %}
                                <span class="badge bg-warning ms-2">قيد المراجعة</span>
                            {% elif report.status.value == 'APPROVED' %}
                                <span class="badge bg-success ms-2">معتمد</span>
                            {% elif report.status.value == 'REJECTED' %}
                                <span class="badge bg-danger ms-2">مرفوض</span>
                            {% endif %}
                        </div>
                        {% if report.submitted_at %}
                        <div class="info-row">
                            <strong>تاريخ الإرسال:</strong>
                            <span class="ms-2">{{ report.submitted_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                {% if report.status.value == 'REJECTED' and report.review_notes %}
                <div class="alert alert-danger mt-3 mb-0">
                    <h6 class="alert-heading">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        سبب الرفض:
                    </h6>
                    <p class="mb-0">{{ report.review_notes }}</p>
                </div>
                {% elif report.status.value == 'APPROVED' and report.review_notes %}
                <div class="alert alert-success mt-3 mb-0">
                    <h6 class="alert-heading">
                        <i class="fas fa-check-circle me-2"></i>
                        ملاحظات المراجع:
                    </h6>
                    <p class="mb-0">{{ report.review_notes }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- أولاً: المعلومات العامة -->
<div class="card section-card border-0 shadow-sm">
    <div class="form-section-header">
        <h5 class="mb-0">أولاً: المعلومات العامة</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="info-row">
                    <strong>اسم الكلب:</strong>
                    <span class="ms-2">
                        {% if report.dog %}
                            {{ report.dog.name }} ({{ report.dog.code }})
                        {% else %}
                            غير محدد
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-row">
                    <strong>موقع العمل:</strong>
                    <span class="ms-2">{{ report.location if report.location else '-' }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ثانياً: فحص الكلب/صحة الكلب -->
{% if report.health %}
<div class="card section-card border-0 shadow-sm">
    <div class="form-section-header">
        <h5 class="mb-0">ثانياً: فحص الكلب/صحة الكلب</h5>
    </div>
    <div class="card-body">
        <!-- العين (Eyes) -->
        <div class="health-check-row">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <strong>1. العين</strong>
                </div>
                <div class="col-md-6">
                    {% if report.health.eyes_status %}
                        <span class="status-badge status-{{ 'normal' if report.health.eyes_status.value == 'سليم' else 'abnormal' if report.health.eyes_status.value == 'غير طبيعي' else 'needs' }}">
                            {{ report.health.eyes_status.value }}
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">{{ report.health.eyes_notes if report.health.eyes_notes else '-' }}</small>
                </div>
            </div>
        </div>

        <!-- الانف (Nose) -->
        <div class="health-check-row">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <strong>2. الانف</strong>
                </div>
                <div class="col-md-6">
                    {% if report.health.nose_status %}
                        <span class="status-badge status-{{ 'normal' if report.health.nose_status.value == 'سليم' else 'abnormal' if report.health.nose_status.value == 'غير طبيعي' else 'needs' }}">
                            {{ report.health.nose_status.value }}
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">{{ report.health.nose_notes if report.health.nose_notes else '-' }}</small>
                </div>
            </div>
        </div>

        <!-- الأذن (Ears) -->
        <div class="health-check-row">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <strong>3. الأذن</strong>
                </div>
                <div class="col-md-6">
                    {% if report.health.ears_status %}
                        <span class="status-badge status-{{ 'normal' if report.health.ears_status.value == 'سليم' else 'abnormal' if report.health.ears_status.value == 'غير طبيعي' else 'needs' }}">
                            {{ report.health.ears_status.value }}
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">{{ report.health.ears_notes if report.health.ears_notes else '-' }}</small>
                </div>
            </div>
        </div>

        <!-- الفم (Mouth) -->
        <div class="health-check-row">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <strong>4. الفم</strong>
                </div>
                <div class="col-md-6">
                    {% if report.health.mouth_status %}
                        <span class="status-badge status-{{ 'normal' if report.health.mouth_status.value == 'سليم' else 'abnormal' if report.health.mouth_status.value == 'غير طبيعي' else 'needs' }}">
                            {{ report.health.mouth_status.value }}
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">{{ report.health.mouth_notes if report.health.mouth_notes else '-' }}</small>
                </div>
            </div>
        </div>

        <!-- الاسنان (Teeth) -->
        <div class="health-check-row">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <strong>5. الاسنان</strong>
                </div>
                <div class="col-md-6">
                    {% if report.health.teeth_status %}
                        <span class="status-badge status-{{ 'normal' if report.health.teeth_status.value == 'سليم' else 'abnormal' if report.health.teeth_status.value == 'غير طبيعي' else 'needs' }}">
                            {{ report.health.teeth_status.value }}
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">{{ report.health.teeth_notes if report.health.teeth_notes else '-' }}</small>
                </div>
            </div>
        </div>

        <!-- اللثة (Gums) -->
        <div class="health-check-row">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <strong>6. اللثة</strong>
                </div>
                <div class="col-md-6">
                    {% if report.health.gums_status %}
                        <span class="status-badge status-{{ 'normal' if report.health.gums_status.value == 'سليم' else 'abnormal' if report.health.gums_status.value == 'غير طبيعي' else 'needs' }}">
                            {{ report.health.gums_status.value }}
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">{{ report.health.gums_notes if report.health.gums_notes else '-' }}</small>
                </div>
            </div>
        </div>

        <!-- الاطراف الامامية (Front legs) -->
        <div class="health-check-row">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <strong>7. الاطراف الامامية</strong>
                </div>
                <div class="col-md-6">
                    {% if report.health.front_limbs_status %}
                        <span class="status-badge status-{{ 'normal' if report.health.front_limbs_status.value == 'سليم' else 'abnormal' if report.health.front_limbs_status.value == 'غير طبيعي' else 'needs' }}">
                            {{ report.health.front_limbs_status.value }}
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">{{ report.health.front_limbs_notes if report.health.front_limbs_notes else '-' }}</small>
                </div>
            </div>
        </div>

        <!-- الاطراف الخلفية (Back legs) -->
        <div class="health-check-row">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <strong>8. الاطراف الخلفية</strong>
                </div>
                <div class="col-md-6">
                    {% if report.health.back_limbs_status %}
                        <span class="status-badge status-{{ 'normal' if report.health.back_limbs_status.value == 'سليم' else 'abnormal' if report.health.back_limbs_status.value == 'غير طبيعي' else 'needs' }}">
                            {{ report.health.back_limbs_status.value }}
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">{{ report.health.back_limbs_notes if report.health.back_limbs_notes else '-' }}</small>
                </div>
            </div>
        </div>

        <!-- الشعر (Hair) -->
        <div class="health-check-row">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <strong>9. الشعر</strong>
                </div>
                <div class="col-md-6">
                    {% if report.health.hair_status %}
                        <span class="status-badge status-{{ 'normal' if report.health.hair_status.value == 'سليم' else 'abnormal' if report.health.hair_status.value == 'غير طبيعي' else 'needs' }}">
                            {{ report.health.hair_status.value }}
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">{{ report.health.hair_notes if report.health.hair_notes else '-' }}</small>
                </div>
            </div>
        </div>

        <!-- الذيل (Tail) -->
        <div class="health-check-row">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <strong>10. الذيل</strong>
                </div>
                <div class="col-md-6">
                    {% if report.health.tail_status %}
                        <span class="status-badge status-{{ 'normal' if report.health.tail_status.value == 'سليم' else 'abnormal' if report.health.tail_status.value == 'غير طبيعي' else 'needs' }}">
                            {{ report.health.tail_status.value }}
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">{{ report.health.tail_notes if report.health.tail_notes else '-' }}</small>
                </div>
            </div>
        </div>

        <!-- المؤخرة (Rear) -->
        <div class="health-check-row">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <strong>11. المؤخرة</strong>
                </div>
                <div class="col-md-6">
                    {% if report.health.rear_status %}
                        <span class="status-badge status-{{ 'normal' if report.health.rear_status.value == 'سليم' else 'abnormal' if report.health.rear_status.value == 'غير طبيعي' else 'needs' }}">
                            {{ report.health.rear_status.value }}
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">{{ report.health.rear_notes if report.health.rear_notes else '-' }}</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ثالثاً: التدريب -->
{% if report.training_sessions %}
<div class="card section-card border-0 shadow-sm">
    <div class="form-section-header">
        <h5 class="mb-0">ثالثاً: التدريب</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="training-table">
                <thead>
                    <tr>
                        <th style="width: 15%;">نوع التدريب</th>
                        <th style="width: 30%;">الوصف</th>
                        <th style="width: 15%;">من</th>
                        <th style="width: 15%;">إلى</th>
                        <th style="width: 25%;">ملاحظات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in report.training_sessions %}
                    <tr>
                        <td class="fw-bold">{{ session.training_type.value }}</td>
                        <td>{{ session.description if session.description else '-' }}</td>
                        <td>{{ session.time_from.strftime('%H:%M') if session.time_from else '-' }}</td>
                        <td>{{ session.time_to.strftime('%H:%M') if session.time_to else '-' }}</td>
                        <td>{{ session.notes if session.notes else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- رابعاً: العناية -->
{% if report.care %}
<div class="card section-card border-0 shadow-sm">
    <div class="form-section-header">
        <h5 class="mb-0">رابعاً: العناية</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="info-row">
                    <strong>كمية الطعام:</strong>
                    <span class="ms-2">{{ report.care.food_amount if report.care.food_amount else '-' }}</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-row">
                    <strong>نوع الطعام:</strong>
                    <span class="ms-2">{{ report.care.food_type if report.care.food_type else '-' }}</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-row">
                    <strong>المكملات الغذائية:</strong>
                    <span class="ms-2">{{ report.care.supplements if report.care.supplements else '-' }}</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-row">
                    <strong>كمية الماء:</strong>
                    <span class="ms-2">{{ report.care.water_amount if report.care.water_amount else '-' }}</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-row">
                    <strong>تمشيط الكلب:</strong>
                    <span class="ms-2">
                        {% if report.care.grooming_done %}
                            <i class="fas fa-check text-success"></i> نعم
                        {% else %}
                            <i class="fas fa-times text-danger"></i> لا
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-row">
                    <strong>غسل الكلب:</strong>
                    <span class="ms-2">
                        {% if report.care.washing_done %}
                            <i class="fas fa-check text-success"></i> نعم
                        {% else %}
                            <i class="fas fa-times text-danger"></i> لا
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-row">
                    <strong>مكان التبرز:</strong>
                    <span class="ms-2">{{ report.care.excretion_location if report.care.excretion_location else '-' }}</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-row">
                    <strong>لون البراز:</strong>
                    <span class="ms-2">{{ report.care.stool_color.value if report.care.stool_color else '-' }}</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-row">
                    <strong>شكل البراز:</strong>
                    <span class="ms-2">{{ report.care.stool_shape.value if report.care.stool_shape else '-' }}</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- خامساً: سلوك الكلب -->
{% if report.behavior %}
<div class="card section-card border-0 shadow-sm">
    <div class="form-section-header">
        <h5 class="mb-0">خامساً: سلوك الكلب</h5>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <strong>السلوك الجيد للكلب/الملاحظات:</strong>
            <p class="mt-2 mb-0">{{ report.behavior.good_behavior_notes if report.behavior.good_behavior_notes else '-' }}</p>
        </div>
        <div>
            <strong>السلوك السيء للكلب/الملاحظات:</strong>
            <p class="mt-2 mb-0">{{ report.behavior.bad_behavior_notes if report.behavior.bad_behavior_notes else '-' }}</p>
        </div>
    </div>
</div>
{% endif %}

<!-- سادساً: حالات الاشتباه والكشف -->
{% if report.incidents and report.incidents|length > 0 %}
<div class="card section-card border-0 shadow-sm">
    <div class="form-section-header">
        <h5 class="mb-0">سادساً: حالات الاشتباه والكشف</h5>
    </div>
    <div class="card-body">
        {% set suspicion_incidents = report.incidents|selectattr('incident_type.value', 'equalto', 'اشتباه')|list %}
        {% set detection_incidents = report.incidents|selectattr('incident_type.value', 'equalto', 'كشف')|list %}
        
        <div class="mb-3">
            <strong>حالات الاشتباه:</strong>
            {% if suspicion_incidents|length > 0 %}
                <ul class="mt-2">
                    {% for incident in suspicion_incidents %}
                    <li>{{ incident.description }}</li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="mt-2 mb-0 text-muted">لا توجد حالات اشتباه</p>
            {% endif %}
        </div>
        <div>
            <strong>حالات الكشف:</strong>
            {% if detection_incidents|length > 0 %}
                <ul class="mt-2">
                    {% for incident in detection_incidents %}
                    <li>{{ incident.description }}</li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="mt-2 mb-0 text-muted">لا توجد حالات كشف</p>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

{% endblock %}
