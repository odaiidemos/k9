{% extends "base.html" %}

{% block title %}تسجيل الحضور{% endblock %}

{% block content %}
<div class="container-fluid rtl">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="h3 text-primary">
                    <i class="fas fa-check-circle me-2"></i>
                    تسجيل الحضور
                </h2>
                <a href="{{ url_for('main.unified_attendance') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                </a>
            </div>

            <!-- Date and Shift Selection -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar me-2"></i>
                        اختيار التاريخ والوردية
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" class="row align-items-end">
                        <div class="col-md-4 mb-3">
                            <label for="date" class="form-label">التاريخ</label>
                            <input type="date" class="form-control" id="date" name="date" 
                                   value="{{ selected_date.strftime('%Y-%m-%d') }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="shift_id" class="form-label">الوردية</label>
                            <select class="form-select" id="shift_id" name="shift_id">
                                {% for shift in shifts %}
                                <option value="{{ shift.id }}" {% if shift.id == selected_shift.id %}selected{% endif %}>
                                    {{ shift.name }} ({{ shift.start_time.strftime('%H:%M') }} - {{ shift.end_time.strftime('%H:%M') }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-refresh me-2"></i>تحديث
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>
                        إجراءات مجمعة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <button type="button" class="btn btn-success w-100" onclick="bulkMarkPresent()">
                                <i class="fas fa-check-circle me-2"></i>تحديد جميع الموظفين كحاضر
                            </button>
                        </div>
                        <div class="col-md-6 mb-2">
                            <div class="input-group">
                                <button type="button" class="btn btn-danger" onclick="bulkMarkAbsent()">
                                    <i class="fas fa-times-circle me-2"></i>تحديد جميع الموظفين كغائب
                                </button>
                                <select class="form-select" id="bulkAbsenceReason">
                                    <option value="NO_REASON">بدون سبب</option>
                                    <option value="ANNUAL">إجازة سنوية</option>
                                    <option value="SICK">إجازة مرضية</option>
                                    <option value="EMERGENCY">إجازة طارئة</option>
                                    <option value="UNAUTHORIZED">غياب بدون إذن</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Recording -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users me-2"></i>
                        قائمة الحضور - {{ selected_shift.name }} - {{ selected_date.strftime('%Y-%m-%d') }}
                    </h5>
                    <span class="badge bg-info">{{ assignments|selectattr('entity_type', 'equalto', EntityType.EMPLOYEE)|list|length }} موظف</span>
                </div>
                <div class="card-body p-0">
                    {% if assignments %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="border-0">رمز الموظف</th>
                                    <th class="border-0">اسم الموظف</th>
                                    <th class="border-0">الحالة</th>
                                    <th class="border-0">السبب/التفاصيل</th>
                                    <th class="border-0">أوقات الدخول/الخروج</th>
                                    <th class="border-0">ملاحظات</th>
                                    <th class="border-0">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for assignment in assignments %}
                                {% if assignment.entity_type == EntityType.EMPLOYEE %}
                                {% set record = attendance_records.get(assignment.entity_type.value + '_' + assignment.entity_id) %}
                                <tr data-entity-type="{{ assignment.entity_type.value }}" data-entity-id="{{ assignment.entity_id }}">
                                    <td><code>{{ assignment.get_entity_code() }}</code></td>
                                    <td><strong>{{ assignment.get_entity_name() }}</strong></td>
                                    <td>
                                        <select class="form-select form-select-sm attendance-status" data-entity="{{ assignment.entity_type.value }}_{{ assignment.entity_id }}">
                                            <option value="">اختر الحالة</option>
                                            <option value="PRESENT" {% if record and record.status.value == 'PRESENT' %}selected{% endif %}>حاضر</option>
                                            <option value="ABSENT" {% if record and record.status.value == 'ABSENT' %}selected{% endif %}>غائب</option>
                                            <option value="LATE" {% if record and record.status.value == 'LATE' %}selected{% endif %}>متأخر</option>
                                        </select>
                                    </td>
                                    <td>
                                        <!-- Absence Reason -->
                                        <select class="form-select form-select-sm absence-reason" 
                                                data-entity="{{ assignment.entity_type.value }}_{{ assignment.entity_id }}"
                                                style="display: {% if record and record.status.value == 'ABSENT' %}block{% else %}none{% endif %};">
                                            <option value="">اختر السبب</option>
                                            <option value="NO_REASON" {% if record and record.absence_reason and record.absence_reason.value == 'NO_REASON' %}selected{% endif %}>بدون سبب</option>
                                            <option value="ANNUAL" {% if record and record.absence_reason and record.absence_reason.value == 'ANNUAL' %}selected{% endif %}>إجازة سنوية</option>
                                            <option value="SICK" {% if record and record.absence_reason and record.absence_reason.value == 'SICK' %}selected{% endif %}>إجازة مرضية</option>
                                            <option value="EMERGENCY" {% if record and record.absence_reason and record.absence_reason.value == 'EMERGENCY' %}selected{% endif %}>إجازة طارئة</option>
                                            <option value="UNAUTHORIZED" {% if record and record.absence_reason and record.absence_reason.value == 'UNAUTHORIZED' %}selected{% endif %}>غياب بدون إذن</option>
                                        </select>
                                        
                                        <!-- Late Reason -->
                                        <input type="text" class="form-control form-control-sm late-reason" 
                                               data-entity="{{ assignment.entity_type.value }}_{{ assignment.entity_id }}"
                                               placeholder="سبب التأخير"
                                               value="{% if record %}{{ record.late_reason or '' }}{% endif %}"
                                               style="display: {% if record and record.status.value == 'LATE' %}block{% else %}none{% endif %};">
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            <input type="time" class="form-control form-control-sm check-in-time" 
                                                   data-entity="{{ assignment.entity_type.value }}_{{ assignment.entity_id }}"
                                                   placeholder="دخول"
                                                   value="{% if record and record.check_in_time %}{{ record.check_in_time.strftime('%H:%M') }}{% endif %}">
                                            <input type="time" class="form-control form-control-sm check-out-time" 
                                                   data-entity="{{ assignment.entity_type.value }}_{{ assignment.entity_id }}"
                                                   placeholder="خروج"
                                                   value="{% if record and record.check_out_time %}{{ record.check_out_time.strftime('%H:%M') }}{% endif %}">
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control form-control-sm attendance-notes" 
                                               data-entity="{{ assignment.entity_type.value }}_{{ assignment.entity_id }}"
                                               placeholder="ملاحظات"
                                               value="{% if record %}{{ record.notes or '' }}{% endif %}">
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-primary btn-sm save-attendance" 
                                                data-entity="{{ assignment.entity_type.value }}_{{ assignment.entity_id }}">
                                            <i class="fas fa-save"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-user-clock fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">لا توجد تعيينات موظفين لهذه الوردية</h5>
                        <p class="text-muted">قم بإضافة تعيينات موظفين أولاً قبل تسجيل الحضور</p>
                        <a href="{{ url_for('main.attendance_assignments') }}" class="btn btn-primary">
                            <i class="fas fa-user-plus me-2"></i>إضافة تعيينات
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle status change
    document.querySelectorAll('.attendance-status').forEach(select => {
        select.addEventListener('change', function() {
            const entityKey = this.dataset.entity;
            const status = this.value;
            
            // Show/hide reason fields based on status
            const absenceReasonSelect = document.querySelector(`.absence-reason[data-entity="${entityKey}"]`);
            const lateReasonInput = document.querySelector(`.late-reason[data-entity="${entityKey}"]`);
            
            // Hide all reason fields first
            absenceReasonSelect.style.display = 'none';
            lateReasonInput.style.display = 'none';
            
            // Show appropriate field based on status
            if (status === 'ABSENT') {
                absenceReasonSelect.style.display = 'block';
            } else if (status === 'LATE') {
                lateReasonInput.style.display = 'block';
            }
        });
    });
    
    // Handle individual save
    document.querySelectorAll('.save-attendance').forEach(button => {
        button.addEventListener('click', function() {
            const entityKey = this.dataset.entity;
            saveAttendance(entityKey);
        });
    });
    
    function saveAttendance(entityKey) {
        const [entityType, entityId] = entityKey.split('_');
        
        const statusSelect = document.querySelector(`.attendance-status[data-entity="${entityKey}"]`);
        const absenceReasonSelect = document.querySelector(`.absence-reason[data-entity="${entityKey}"]`);
        const lateReasonInput = document.querySelector(`.late-reason[data-entity="${entityKey}"]`);
        const checkInTimeInput = document.querySelector(`.check-in-time[data-entity="${entityKey}"]`);
        const checkOutTimeInput = document.querySelector(`.check-out-time[data-entity="${entityKey}"]`);
        const notesInput = document.querySelector(`.attendance-notes[data-entity="${entityKey}"]`);
        
        const status = statusSelect.value;
        if (!status) {
            showAlert('warning', 'يرجى اختيار حالة الحضور');
            return;
        }
        
        const data = {
            shift_id: '{{ selected_shift.id }}',
            entity_type: entityType,
            entity_id: entityId,
            date: '{{ selected_date.strftime("%Y-%m-%d") }}',
            status: status,
            absence_reason: status === 'ABSENT' ? absenceReasonSelect.value : null,
            late_reason: status === 'LATE' ? lateReasonInput.value : null,
            check_in_time: checkInTimeInput.value || null,
            check_out_time: checkOutTimeInput.value || null,
            notes: notesInput.value || ''
        };
        
        fetch('{{ url_for("main.attendance_record_save") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert('success', result.message);
                // Update button state
                const button = document.querySelector(`.save-attendance[data-entity="${entityKey}"]`);
                button.classList.remove('btn-primary');
                button.classList.add('btn-success');
                button.innerHTML = '<i class="fas fa-check"></i>';
                
                setTimeout(() => {
                    button.classList.remove('btn-success');
                    button.classList.add('btn-primary');
                    button.innerHTML = '<i class="fas fa-save"></i>';
                }, 2000);
            } else {
                showAlert('danger', result.error);
            }
        })
        .catch(error => {
            showAlert('danger', 'حدث خطأ في تسجيل الحضور');
            if (error && error.message) { console.error('Error:', error.message); }
        });
    }
    
    window.bulkMarkPresent = function() {
        if (confirm('هل أنت متأكد من تحديد جميع الموظفين كحاضرين؟')) {
            bulkAction('mark_all_present');
        }
    };
    
    window.bulkMarkAbsent = function() {
        const reason = document.getElementById('bulkAbsenceReason').value;
        if (confirm('هل أنت متأكد من تحديد جميع الموظفين كغائبين؟')) {
            bulkAction('mark_all_absent', reason);
        }
    };
    
    function bulkAction(action, absenceReason = null) {
        const data = {
            action: action,
            shift_id: '{{ selected_shift.id }}',
            date: '{{ selected_date.strftime("%Y-%m-%d") }}',
            absence_reason: absenceReason
        };
        
        fetch('{{ url_for("main.attendance_bulk") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert('success', result.message);
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('danger', result.error);
            }
        })
        .catch(error => {
            showAlert('danger', 'حدث خطأ في العملية المجمعة');
            if (error && error.message) { console.error('Error:', error.message); }
        });
    }
    
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}